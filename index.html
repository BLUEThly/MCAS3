<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>新規ミームコイン データ収集・分析支援 (Ethereum / latest)</title>
<style>
  :root{--bg:#0f1720;--panel:#141c27;--text:#e6edf3;--muted:#94a3b8;--acc:#60a5fa;--ok:#16a34a;--warn:#f59e0b;--err:#ef4444;border:0}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic UI","Meiryo",sans-serif}
  h1{font-size:20px;margin:16px}
  .page{display:grid;gap:16px;padding:0 16px 24px}
  .grid{display:grid;gap:12px}
  .panel{background:var(--panel);border-radius:12px;padding:16px}
  label{display:block;color:var(--muted);margin:6px 0 4px}
  input[type="text"],input[type="number"],input[type="date"]{width:100%;background:#0b1118;border:1px solid #1f2937;border-radius:8px;color:var(--text);padding:10px}
  .row{display:grid;gap:12px}
  @media(min-width:920px){.row{grid-template-columns:1fr 1fr}}
  .actions{display:flex;gap:12px;flex-wrap:wrap;margin-top:8px}
  button{background:#1e293b;color:#fff;border:1px solid #2b3a4e;border-radius:10px;padding:10px 14px;cursor:pointer}
  button:hover{border-color:#41536b}
  .btn-primary{background:var(--acc)}
  .console{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;white-space:pre-wrap;background:#0b1118;border-radius:8px;padding:12px;min-height:140px}
  .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{padding:10px;border-top:1px solid #1f2937}
  th{position:sticky;top:0;background:#0b1118}
  .muted{color:var(--muted)}
  small{color:var(--muted)}
</style>
</head>
<body>
  <h1>新規ミームコイン データ収集・分析支援 <span class="muted">(Ethereum / latest)</span></h1>

  <div class="page">
    <div class="row">
      <section class="panel grid" id="form">
        <div>
          <label>観測期間の開始日</label>
          <input type="date" id="startDate" />
        </div>
        <div>
          <label>観測期間の終了日</label>
          <input type="date" id="endDate" />
        </div>
        <div>
          <label>急騰判定 期間（日）<small class="muted">（Gecko版は参考表示のみ）</small></label>
          <input type="number" id="days" value="14" min="1" step="1" />
        </div>
        <div>
          <label>急騰判定 倍率（×）<small class="muted">（Gecko版は参考表示のみ）</small></label>
          <input type="number" id="mult" value="3" min="1" step="0.5" />
        </div>
        <div>
          <label>LPロック閾値（%）<small class="muted">（Gecko版は現状未使用）</small></label>
          <input type="number" id="lpMin" value="80" min="0" max="100" step="5" />
        </div>
        <div>
          <label>最大表示件数（UIのみ）</label>
          <input type="number" id="maxRows" value="150" min="10" step="10" />
        </div>
        <div class="grid">
          <div>
            <label>(任意) Cloudflare Workers プロキシURL</label>
            <input type="text" id="workerUrl" placeholder="https://cors-proxy.***.workers.dev/?url=" />
            <small>モバイルアプリ内WebView等でCORSが強い場合に設定（保存されます）。</small>
          </div>
        </div>
        <div class="actions">
          <button id="runBtn" class="btn-primary">分析開始</button>
          <button id="csvBtn">CSVをダウンロード</button>
        </div>
      </section>

      <section class="panel">
        <div class="console" id="log"></div>
      </section>
    </div>

    <section class="panel">
      <table id="tbl">
        <thead>
          <tr>
            <th>#</th>
            <th>Token / Pool</th>
            <th>Address</th>
            <th>h1%</th>
            <th>h6%</th>
            <th>h24%</th>
            <th>作成日時</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <small class="muted">© 2025 — Ethereum only（他チェーンは拡張容易な設計） / データ: GeckoTerminal（無料エンドポイント）</small>
    </section>
  </div>

<script>
(() => {
  const el = id => document.getElementById(id);
  const logEl = el('log');
  const tbody = document.querySelector('#tbl tbody');
  const workerInput = el('workerUrl');

  // 初期値（期間は本日まで / 6週間前を開始）
  const today = new Date();
  const fmt = d => d.toISOString().slice(0,10);
  el('endDate').value = fmt(today);
  const start = new Date(Date.now() - 42*24*3600*1000);
  el('startDate').value = fmt(start);

  // 保存されたWorkers URL
  try {
    const saved = localStorage.getItem('mca_worker_url');
    if (saved) workerInput.value = saved;
  } catch {}

  function log(msg, cls='') {
    const line = document.createElement('div');
    if (cls) line.className = cls;
    line.textContent = msg;
    logEl.appendChild(line);
    logEl.scrollTop = logEl.scrollHeight;
  }
  function clearLog() { logEl.textContent=''; }

  function proxied(url){
    const base = workerInput.value.trim();
    if (!base) return url; // 直アクセス（CORSが緩い環境向け）
    return base + encodeURIComponent(url);
  }

  async function backoffFetch(url, opt={}, tries=3){
    let wait = 800; // ms
    for (let i=0;i<tries;i++){
      const res = await fetch(url, opt);
      if (res.ok) return res;
      // 429/503はリトライ、それ以外は即終了
      if (res.status !== 429 && res.status !== 503) throw new Error('HTTP '+res.status);
      await new Promise(r=>setTimeout(r, wait + Math.random()*400));
      wait *= 1.8;
    }
    throw new Error('HTTP backoff exceeded');
  }

  // ------- ここが修正点：ethereum → eth -------
  const GT_BASE   = 'https://api.geckoterminal.com/api/v2';
  const NETWORK   = 'eth'; // ← ここをethに統一
  const TREND_URL = `${GT_BASE}/networks/${NETWORK}/trending_pools?aggregate=1&limit=90`;
  // -------------------------------------------

  async function fetchTrending(){
    const url = proxied(TREND_URL);
    const res = await backoffFetch(url, {}, 4).catch(err=>{
      log(`trending fetch failed: ${err.message}`, 'err');
      throw err;
    });
    const json = await res.json();
    if (!json.data) throw new Error('No data');
    return json.data;
  }

  function row(obj, i){
    const attr = obj.attributes || {};
    const id = (attr.address || '').trim();
    const pct = attr.price_change_percentage || {};
    const created = attr.pool_created_at ? new Date(attr.pool_created_at).toISOString().replace('T',' ').slice(0,16) : '';
    return {
      no: i+1,
      name: attr.name || '',
      address: id,
      h1: Number(pct.h1 ?? 0),
      h6: Number(pct.h6 ?? 0),
      h24: Number(pct.h24 ?? 0),
      created
    };
  }

  function render(rows){
    tbody.innerHTML = '';
    const max = Number(el('maxRows').value || 150);
    rows.slice(0,max).forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.no}</td>
        <td>${escapeHtml(r.name)}</td>
        <td><a href="https://dexscreener.com/ethereum/${r.address}" target="_blank" rel="noopener">${r.address}</a></td>
        <td>${fmtPct(r.h1)}</td>
        <td>${fmtPct(r.h6)}</td>
        <td>${fmtPct(r.h24)}</td>
        <td>${r.created}</td>`;
      tbody.appendChild(tr);
    });
  }

  function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  function fmtPct(v){ return (v>=0?'+':'') + (isFinite(v)? v.toFixed(2):'0.00'); }

  // CSV
  el('csvBtn').addEventListener('click', ()=>{
    const rows = [...tbody.querySelectorAll('tr')].map(tr => [...tr.children].map(td => td.textContent));
    if (!rows.length){ alert('データがありません'); return; }
    const head = ['#','Token/Pool','Address','h1%','h6%','h24%','CreatedAt'];
    const csv = [head, ...rows].map(r => r.map(x => `"${String(x).replace(/"/g,'""')}"`).join(',')).join('\r\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `meme_trending_eth_${Date.now()}.csv`;
    a.click();
    URL.revokeObjectURL(a.href);
  });

  // 実行
  el('runBtn').addEventListener('click', async ()=>{
    // Workersの保存
    try {
      const val = workerInput.value.trim();
      if (val) localStorage.setItem('mca_worker_url', val);
    } catch {}
    clearLog();
    const s = el('startDate').value, e = el('endDate').value;
    const days = Number(el('days').value||14), mult = Number(el('mult').value||3);
    const startTs = Math.floor(new Date(s).getTime()/1000);
    const endTs   = Math.floor(new Date(e).getTime()/1000);
    log(`Params: days=${days}, mult=${mult}, LP≥${el('lpMin').value}%, start=${startTs}, end=${endTs}`);

    tbody.innerHTML = '';
    let seeds = [];
    try {
      const items = await fetchTrending();
      log(`GeckoTerminal trending seeds: ${items.length}`);
      seeds = items.map((d,i)=>row(d,i));
      log(`Total unique seeds: ${seeds.length}`);
      render(seeds);
      log(`完了: ${seeds.length} hits (showing ${Math.min(seeds.length, Number(el('maxRows').value||150))})`, 'ok');
    } catch(err){
      log(`trending fetch failed: ${err.message}`, 'err');
      log('完了: 0 hits (showing 0)', 'warn');
    }
  });

})();
</script>
</body>
</html>
