<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>新規ミームコイン データ収集・分析支援 (Ethereum)</title>
<style>
  :root { color-scheme: dark; }
  body { margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif; background:#0b0f14; color:#e6f0ff;}
  .wrap { max-width: 1100px; margin: 24px auto; padding: 0 16px; }
  h1{font-size:20px; margin:0 0 16px;}
  .grid { display:grid; grid-template-columns: 1fr 1fr; gap:14px;}
  .card { background:#121924; border:1px solid #203042; border-radius:10px; padding:14px;}
  label{display:block; font-size:12px; color:#96adcb; margin-bottom:6px;}
  input,button { width:100%; padding:10px 12px; border-radius:8px; border:1px solid #2a3a4f; background:#0e1520; color:#e6f0ff;}
  input[type="range"]{padding:0;}
  small{color:#8aa1b9;}
  .row { display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
  .actions { display:flex; gap:10px; }
  .btn-primary { background:#0a6cff; border-color:#2c6fe6; cursor:pointer; }
  .btn-secondary { background:#0e1520; border-color:#2a3a4f; }
  .log { white-space:pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background:#0e1520; border:1px solid #2a3a4f; border-radius:10px; padding:12px; min-height:220px; overflow:auto;}
  table{width:100%; border-collapse: collapse; margin-top:14px; font-size:13px;}
  th,td{border-bottom:1px solid #203042; padding:8px 6px; text-align:left;}
  th{color:#9fb7d6;}
  .muted{color:#8aa1b9}
</style>
</head>
<body>
<div class="wrap">
  <h1>新規ミームコイン データ収集・分析支援 <span class="muted">(Ethereum / latest)</span></h1>

  <div class="grid">
    <div class="card">
      <div class="row">
        <div>
          <label>観測期間の開始日</label>
          <input type="date" id="startDate" />
        </div>
        <div>
          <label>観測期間の終了日</label>
          <input type="date" id="endDate" />
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div>
          <label>急騰判定 期間（日）</label>
          <input type="number" id="days" min="7" max="60" value="14" />
        </div>
        <div>
          <label>急騰判定 倍率（×）</label>
          <input type="number" id="mult" step="0.1" min="1" value="3" />
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div>
          <label>LPロック 閾値（%）</label>
          <input type="number" id="lpMin" min="0" max="100" value="80" />
        </div>
        <div>
          <label>最大表示件数（UIのみ）</label>
          <input type="number" id="maxTokens" min="5" max="200" value="150" />
        </div>
      </div>

      <div style="margin-top:10px;">
        <label>（任意）Cloudflare Workers プロキシURL</label>
        <input id="workerUrl" type="text" placeholder="https://cors-proxy.あなたのID.workers.dev/?url=" />
        <small>モバイルアプリ内WebView等でCORSが強い場合に設定（保存されます）。</small>
      </div>

      <div class="actions" style="margin-top:12px;">
        <button class="btn-primary" id="runBtn">分析開始</button>
        <button class="btn-secondary" id="csvBtn" disabled>CSVをダウンロード</button>
      </div>
    </div>

    <div class="card">
      <label>Console Messages</label>
      <div id="log" class="log"></div>
    </div>
  </div>

  <div class="card" style="margin-top:14px;">
    <table id="tbl">
      <thead>
        <tr>
          <th>#</th><th>Token / Pool</th><th>Address</th><th>h1%</th><th>h6%</th><th>h24%</th><th>作成日時</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="muted" style="margin-top:8px;">© 2025 — Ethereum only（他チェーンは拡張容易な設計）/ データ: GeckoTerminal（無料エンドポイント）</div>
  </div>
</div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const logEl = $('log');
  const tblBody = document.querySelector('#tbl tbody');

  // ---------- utils ----------
  const sleep = ms => new Promise(r=>setTimeout(r, ms));
  const now = ()=> new Date();

  function log(msg, color){
    const line = typeof msg === 'string' ? msg : JSON.stringify(msg);
    logEl.innerHTML += (color ? `%c${line}` : line) + "\n";
    if(color){
      // keep the color but also print plain text for copy
      console.log(line);
    } else {
      console.log(line);
    }
    logEl.scrollTop = logEl.scrollHeight;
  }

  function saveWorkerUrl(v){ try{ localStorage.setItem('workerUrl', v||''); }catch{} }
  function loadWorkerUrl(){ try{ return localStorage.getItem('workerUrl')||''; }catch{ return '';} }

  // ---------- rate limiter (sequential + jitter) ----------
  const BASE_DELAY = 500;      // 429 対策: 1 リクエストあたり 0.5s
  const JITTER_MIN = 120, JITTER_MAX = 280;

  async function rateGuard(){
    const jitter = Math.floor(JITTER_MIN + Math.random()*(JITTER_MAX-JITTER_MIN));
    await sleep(BASE_DELAY + jitter);
  }

  // ---------- proxied fetch with 429-aware retry ----------
  async function fetchJsonWithRetry(rawUrl, opts={}){
    const workerBase = $('workerUrl').value.trim();
    const target = rawUrl;
    const build = (u)=> workerBase ? (workerBase + encodeURIComponent(u)) : u;

    let attempt = 0;
    const MAX_ATTEMPTS = 6;

    while(true){
      await rateGuard(); // まずは間引き

      let res;
      try{
        res = await fetch(build(target), { headers: { 'accept': 'application/json' }});
      }catch(e){
        // ネットワーク系は少し待ってリトライ
        attempt++;
        if(attempt>=MAX_ATTEMPTS) throw e;
        const backoff = Math.min(4000, 300 * 2**attempt);
        log(`network error -> retry in ${backoff}ms`);
        await sleep(backoff);
        continue;
      }

      if(res.status === 429){
        attempt++;
        const ra = parseInt(res.headers.get('retry-after')||'0',10);
        const waitMs = ra ? (ra*1000) : Math.min(5000, 400 * 2**attempt);
        log(`429 Too Many Requests -> retry in ${waitMs}ms`);
        if(attempt>=MAX_ATTEMPTS) throw new Error('429 repeatedly');
        await sleep(waitMs);
        continue;
      }

      if(!res.ok){
        // 4xx/5xx 他はそのまま例外
        const txt = await res.text().catch(()=>String(res.status));
        throw new Error(`HTTP ${res.status} ${txt.slice(0,200)}`);
      }

      return res.json();
    }
  }

  // ---------- API helpers ----------
  const GT_BASE = 'https://api.geckoterminal.com';

  async function getTrendingSeeds(limit=30){
    // Ethereum / trending pools
    const url = `${GT_BASE}/api/v2/networks/ethereum/trending_pools?aggregate=1&limit=${encodeURIComponent(limit)}`;
    const j = await fetchJsonWithRetry(url);
    const arr = (j && j.data) ? j.data : [];
    // 返って来るのは {id:"eth_0x...", type:"pool", attributes:{...}}
    return arr.map(x=>x.id);
  }

  async function getPoolDetail(poolId){
    // 単一プールの詳細
    const url = `${GT_BASE}/api/v2/pools/${encodeURIComponent(poolId)}`;
    const j = await fetchJsonWithRetry(url);
    // attributes の中に price_change_percentage や pool_created_at など
    const d = j && j.data;
    if(!d) return null;
    const a = d.attributes || {};
    return {
      id: d.id,
      name: a.name || '',
      created_at: a.pool_created_at || '',
      h1: n(a.price_change_percentage && a.price_change_percentage.h1),
      h6: n(a.price_change_percentage && a.price_change_percentage.h6),
      h24: n(a.price_change_percentage && a.price_change_percentage.h24),
      address: a.address || (d.id.split('_')[1] || '')
    };
  }

  const n = (v)=> (v===null || v===undefined) ? null : Number(v);

  // ---------- CSV ----------
  function toCSV(rows){
    const header = ['#','Token / Pool','Address','h1%','h6%','h24%','CreatedAt'];
    const body = rows.map((r,i)=>[
      i+1, wrapCsv(r.name), wrapCsv(r.address), r.h1, r.h6, r.h24, wrapCsv(r.created_at)
    ].join(','));
    return [header.join(','), ...body].join('\n');
  }
  function wrapCsv(s){ s = (s||'').toString(); if(/[,"\n]/.test(s)){ return `"${s.replace(/"/g,'""')}"`; } return s; }

  // ---------- main ----------
  $('workerUrl').value = loadWorkerUrl();
  $('workerUrl').addEventListener('change', e=> saveWorkerUrl(e.target.value));

  // 初期日付
  const today = new Date();
  const endISO = new Date(today.getTime()-24*3600*1000).toISOString().slice(0,10);
  const startISO = new Date(today.getTime()-14*24*3600*1000).toISOString().slice(0,10);
  $('startDate').value = startISO;
  $('endDate').value = endISO;

  let latestRows = [];

  $('runBtn').addEventListener('click', async ()=>{
    logEl.textContent = '';
    tblBody.innerHTML = '';
    latestRows = [];
    const days = Number($('days').value||14);
    const mult = Number($('mult').value||3);
    const lpMin = Number($('lpMin').value||80);
    const maxTokens = Math.max(5, Math.min(200, Number($('maxTokens').value||100)));

    const start = Math.floor(new Date($('startDate').value).getTime()/1000);
    const end   = Math.floor(new Date($('endDate').value).getTime()/1000);
    log(`Params: days=${days}, mult=${mult}, LP≥${lpMin}%, start=${start}, end=${end}`);

    // まずは seed 収集
    let seeds = [];
    try{
      seeds = await getTrendingSeeds(30); // まず 30 まで
      log(`GeckoTerminal trending seeds: ${seeds.length}`);
    }catch(e){
      log(`trending fetch failed: ${e.message}`);
    }

    log(`Total unique seeds: ${seeds.length}`);

    // 各 seed を順次処理（※並列禁止 / レートガードあり）
    let shown = 0, idx=0;
    for(const poolId of seeds){
      idx++;
      try{
        const d = await getPoolDetail(poolId);
        if(!d) continue;

        // ここに必要であれば LP ロックや急騰判定のフィルタを追加
        // 今回は h24 が存在するものを表示
        latestRows.push(d);
        if(shown < maxTokens){
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${shown+1}</td>
            <td>${escapeHtml(d.name||'')}</td>
            <td>${short(d.address)}</td>
            <td>${fmtp(d.h1)}</td>
            <td>${fmtp(d.h6)}</td>
            <td>${fmtp(d.h24)}</td>
            <td>${escapeHtml(d.created_at||'')}</td>`;
          tblBody.appendChild(tr);
          shown++;
        }
      }catch(e){
        log(`fetch failed: ${e.message}`);
      }
    }

    log(`完了: ${shown} hits (showing ${shown})`);
    $('csvBtn').disabled = latestRows.length===0;
  });

  $('csvBtn').addEventListener('click', ()=>{
    const csv = toCSV(latestRows);
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'meme_coins.csv';
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  });

  // helpers
  function fmtp(x){ return (x===null || x===undefined || isNaN(x)) ? '' : x.toFixed(3); }
  function short(a){ if(!a) return ''; return a.slice(0,6)+'…'+a.slice(-4); }
  function escapeHtml(s){ return (s||'').toString().replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }
})();
</script>
</body>
</html>
