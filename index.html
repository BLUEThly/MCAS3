<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ミームコイン自動スクリーニング（ETH）— 厳密モード＋カレンダー期間＋Googleトレンド相関</title>
<style>
  :root{--bg:#0f172a;--panel:#0b1220;--text:#e5e7eb;--muted:#9ca3af;--good:#22c55e;--bad:#ef4444;--warn:#f59e0b;--link:#93c5fd;--chip:#1f2937;--border:#1f2937;--btn:#1d4ed8}
  html,body{background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,Segoe UI,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";margin:0}
  header{padding:18px 14px;border-bottom:1px solid var(--border);background:var(--panel)}
  h1{font-size:16px;margin:0 0 10px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:end}
  .ctl{display:flex;flex-direction:column;gap:6px}
  label{font-size:12px;color:var(--muted)}
  input,select,button{background:#0f172a;border:1px solid #293145;color:var(--text);padding:8px 10px;border-radius:8px;font-size:14px}
  input[type="checkbox"]{width:auto}
  button{cursor:pointer}
  button.primary{background:var(--btn);border-color:var(--btn)}
  button.ghost{background:var(--panel)}
  button.red{background:#7f1d1d;border-color:#7f1d1d}
  .pill{background:var(--chip);padding:6px 10px;border-radius:999px;color:#cbd5e1;font-size:12px}
  main{padding:16px}
  .log{white-space:pre-wrap;background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:10px;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .log .err{color:#ef4444}
  table{width:100%;border-collapse:separate;border-spacing:0 6px}
  thead th{font-size:12px;color:#9ca3af;text-align:left;padding:6px 8px}
  tbody tr{background:#0b1220}
  td{padding:8px 8px;font-size:13px;border-top:1px solid var(--border);border-bottom:1px solid var(--border)}
  tbody tr td:first-child{border-left:1px solid var(--border);border-radius:8px 0 0 8px}
  tbody tr td:last-child{border-right:1px solid var(--border);border-radius:0 8px 8px 0}
  a{color:var(--link);text-decoration:none}
  .num{font-variant-numeric:tabular-nums}
  .good{color:var(--good)} .bad{color:var(--bad)} .warn{color:var(--warn)}
  .bar{height:8px;background:#0a1a38;border:1px solid #1f2b45;border-radius:999px;overflow:hidden}
  .bar>div{height:100%;width:0;background:#2563eb;transition:width .2s}
  .hint{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<header>
  <h1>ミームコイン自動スクリーニング（ETH）— 厳密モード＋カレンダー期間＋Googleトレンド相関</h1>

  <!-- ---- 基本パラメータ ---- -->
  <div class="row">
    <div class="ctl"><label>days（急騰検出の直近日数）</label><input id="days" type="number" value="14" min="2" max="60"></div>
    <div class="ctl"><label>mult（ピーク/直前minの倍率）</label><input id="mult" type="number" value="3" min="1.001" step="0.001"></div>
    <div class="ctl"><label>LP% しきい値（burn/locker合算）</label><input id="lpmin" type="number" value="80" min="0" max="100"></div>
    <div class="ctl"><label>Trending 種（上限）</label><input id="seedLimit" type="number" value="20" min="5" max="100"></div>
    <div class="ctl"><label>厳密モード</label><div><input id="strict" type="checkbox" checked> <span class="pill">days×mult と LP% フィルタを適用</span></div></div>
    <div class="ctl"><label>LP%必須</label><div><input id="lpRequired" type="checkbox" checked> <span class="pill">LP%が取れない行は除外</span></div></div>
    <div class="ctl"><label>LP取得は倍率通過後のみ</label><div><input id="lpAfterMult" type="checkbox" checked> <span class="pill">mult未達はEthplorerを呼ばない</span></div></div>
    <div class="ctl"><label>表示</label><div><input id="showAll" type="checkbox" checked> <span class="pill">全件表示（しきい値未達も出す）</span></div></div>
  </div>

  <!-- ---- 期間 & CORS / Trends API ---- -->
  <div class="row" style="margin-top:8px">
    <div class="ctl"><label>抽出期間（開始, カレンダー）</label><input id="dateStart" type="date"></div>
    <div class="ctl"><label>抽出期間（終了, カレンダー）</label><input id="dateEnd" type="date"></div>
    <div class="ctl" style="min-width:260px"><label>（任意）CORS プロキシ（Ethplorer/Gecko 用）</label><input id="cors" placeholder="https://your-worker.workers.dev/?url="></div>
    <!-- ★ 追加：TrendsはWorkers /series を第一選択 -->
    <div class="ctl" style="min-width:320px"><label>（推奨）Trends API（Workers /series のURL）</label><input id="trApi" placeholder="https://<your>.workers.dev/series"></div>
    <div class="ctl" style="min-width:220px"><label>（任意）Ethplorer API key</label><input id="ethKey" placeholder="未入力なら freekey を使用"></div>
    <div class="ctl">
      <label>&nbsp;</label>
      <div style="display:flex;gap:8px">
        <button class="primary" id="runBtn" type="button">スキャン実行</button>
        <button class="red" id="cancelBtn" type="button" disabled>キャンセル</button>
        <button class="ghost" id="csvBtn" type="button" disabled>CSV</button>
      </div>
    </div>
  </div>

  <details>
    <summary style="cursor:pointer;color:#cbd5e1">詳細設定（UNIX秒による期間指定・既定は空）</summary>
    <div class="row" style="margin-top:6px">
      <div class="ctl"><label>開始（UNIX秒）</label><input id="startTs" placeholder="例: 1754006400"></div>
      <div class="ctl"><label>終了（UNIX秒）</label><input id="endTs" placeholder="例: 1758067200"></div>
    </div>
  </details>

  <!-- ---- Googleトレンド相関 ---- -->
  <div style="margin-top:14px"></div>
  <div class="row">
    <div class="ctl"><label>相関：地域（geo）</label>
      <select id="trGeo">
        <option value="">Global</option>
        <option value="JP" selected>JP</option>
        <option value="US">US</option>
        <option value="KR">KR</option>
        <option value="TW">TW</option>
        <option value="GB">GB</option>
        <option value="DE">DE</option>
      </select>
    </div>
    <div class="ctl"><label>相関：最大ラグ（±日）</label><input id="trLag" type="number" value="7" min="0" max="21"></div>
    <div class="ctl"><label>相関の系列</label>
      <select id="trMode">
        <option value="level" selected>レベル同士（そのまま）</option>
        <option value="ret">日次リターン同士</option>
      </select>
    </div>
    <div class="ctl">
      <label>&nbsp;</label>
      <div style="display:flex;gap:8px">
        <button class="ghost" id="corrBtn" type="button" disabled>相関を計算</button>
        <span class="hint">※ スキャン完了後に有効化</span>
      </div>
    </div>
  </div>
</header>

<main>
  <div id="params" class="log" style="margin-bottom:10px">待機中：上のパラメータをセットして「スキャン実行」を押してください。</div>

  <div class="bar"><div id="pbar"></div></div>
  <div style="height:8px"></div>
  <div class="pill" id="progress">idle</div>

  <div style="height:10px"></div>
  <div class="log" id="notes"></div>
  <div style="height:14px"></div>
  <div id="wrapTable"></div>

  <footer>© 2025 — Ethereum only｜データ: GeckoTerminal（日足OHLCV） / DexScreener（トレンド補助） / Ethplorer（TopHolders） / Google Trends（/series 経由推奨）</footer>
</main>

<script>
/* ============ Utils ============ */
const by=id=>document.getElementById(id);
const sleep=ms=>new Promise(r=>setTimeout(r,ms));
const ts2=t=>new Date(t*1000).toLocaleString();
const fmt=x=>x==null||Number.isNaN(+x)?'':(+x).toFixed(3);
const jitter=(a=120,b=420)=>Math.floor(Math.random()*(b-a+1))+a;
const normTs=t=> (t>1e12?Math.floor(t/1000):t);
function log(m,e=false){const L=by('notes');const line=`[${new Date().toLocaleTimeString()}] ${m}`;L.innerHTML+=e?`<div class="err">${line}</div>`:`<div>${line}</div>`;L.scrollTop=L.scrollHeight;}
function setBar(f){by('pbar').style.width=`${Math.max(0,Math.min(1,f))*100}%`;}

/* ============ Fetch helper（CORS ルーティング） ============ */
function buildProxiedUrl(base,url){
  if(!base)return url;
  const b=base.trim();
  if(/\{url\}/i.test(b)) return b.replace(/\{url\}/ig,encodeURIComponent(url));
  if(/[\?&]url=$/i.test(b)||(/\?$/.test(b)&&/url=/.test(b))) return b+encodeURIComponent(url);
  if(/[\?&]url=\/$/.test(b)) return b.replace(/\/$/,'')+encodeURIComponent(url);
  return b.replace(/\/+$/,'')+'/'+url;
}
async function _fetchJson(u,{timeout=14000,label=''}={}){const ac=new AbortController();const tid=setTimeout(()=>ac.abort('timeout'),timeout);try{if(label)log(`GET ${label}: ${u.slice(0,140)}`);const r=await fetch(u,{signal:ac.signal});if(!r.ok)throw new Error(`HTTP ${r.status}`);const ct=(r.headers.get('content-type')||'').toLowerCase();const body=ct.includes('application/json')?await r.json():JSON.parse(await r.text());clearTimeout(tid);return body;}catch(e){clearTimeout(tid);throw e;}}
async function getJsonSmart(url,{label='',timeout=14000}={}){const h=new URL(url).hostname;const user=by('cors').value.trim();
  let bases;
  if(h.includes('geckoterminal.com')||h.includes('dexscreener.com')) bases=['','https://cors.isomorphic-git.org/'];
  else if(h.includes('ethplorer.io')) bases=[user||'','https://cors.isomorphic-git.org/','https://corsproxy.io/?url=','https://api.allorigins.win/raw?url='];
  else bases=['','https://cors.isomorphic-git.org/'];
  let last;
  for(const b of bases){const u=buildProxiedUrl(b,url);try{return await _fetchJson(u,{timeout,label});}
    catch(e){last=e;log(`…via ${b||'DIRECT'} failed: ${e.message||e}`,true);} }
  throw last;
}

/* ============ CSV ============ */
function toCSV(rows){const esc=v=>v==null?'':/[",\n]/.test(String(v))?`"${String(v).replace(/"/g,'""')}"`:String(v);const head=Object.keys(rows[0]||{});const out=[head.map(esc).join(',')];for(const r of rows)out.push(head.map(k=>esc(r[k])).join(','));return out.join('\n');}
function dl(name,text){const blob=new Blob([text],{type:'text/csv'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=name;a.click();URL.revokeObjectURL(a.href);}

/* ============ 時刻 ============ */
function dateToStartUnix(s){if(!s)return null;const d=new Date(s+'T00:00:00');return Math.floor(d.getTime()/1000);}
function dateToEndUnix(s){if(!s)return null;const d=new Date(s+'T23:59:59');return Math.floor(d.getTime()/1000)+1;}
function datePrefToUnix(){let s=dateToStartUnix(by('dateStart').value);let e=dateToEndUnix(by('dateEnd').value);if(by('startTs').value)s=+by('startTs').value;if(by('endTs').value)e=+by('endTs').value;return {startTs:s,endTs:e};}

/* ============ レート制御 ============ */
let lastEth=0,lastGecko=0,geckoPenalty=0;
const ETHPLORER_MIN_INTERVAL = 4000;
let GECKO_MIN_INTERVAL=700;

/* ★ Trends 呼び出しのスロットリング */
let lastTr=0;
const TRENDS_MIN_INTERVAL = 1200;

/* ============ トレンド種取得 ============ */
function parseGeckoTokenId(id){ if(!id)return ''; const parts=id.split('_'); return parts[parts.length-1]?.toLowerCase()||''; }
async function getTrendingSeeds({limit=20}){
  try{
    const j=await getJsonSmart('https://api.geckoterminal.com/api/v2/networks/eth/trending_pools?page=1',{label:'Gecko trending'});
    const arr=(j?.data||[]).slice(0,limit);
    const pools=arr.map(x=>{
      const poolAddress=x?.attributes?.address;
      const baseId=x?.relationships?.base_token?.data?.id;
      const baseSym=x?.attributes?.base_token_symbol||'';
      return { poolAddress, tokenAddress:parseGeckoTokenId(baseId), baseSymbol:baseSym, name:x?.attributes?.name||'' };
    }).filter(x=>x.poolAddress);
    if(pools.length){log(`Gecko trending: ${pools.length} seeds`);return {seeds:pools,source:'GeckoTerminal'};}
  }catch(e){log(`Gecko trending failed: ${e.message||e}`,true);}
  const j2=await getJsonSmart(`https://api.dexscreener.com/latest/dex/trending?limit=${limit}`,{label:'DexScreener trending'});
  const seeds=(j2?.pairs||[]).filter(p=>p.chainId==='ethereum'||p.chainId==='eth').slice(0,limit).map(p=>({
    poolAddress:p.pairAddress, tokenAddress:(p.baseToken?.address||'').toLowerCase(), baseSymbol:(p.baseToken?.symbol||'').toUpperCase(), name:p.baseToken?.symbol&&p.quoteToken?.symbol?`${p.baseToken.symbol}/${p.quoteToken.symbol}`:(p.symbol||'')
  }));
  log(`DexScreener trending: ${seeds.length} seeds`);
  return {seeds,source:'DexScreener'};
}

/* ============ Gecko OHLCV 抽出（互換） ============ */
function extractGeckoCandles(json){
  const attr = json?.data?.attributes || json?.data?.[0]?.attributes || {};
  const cands = [attr.candles, attr.ohlcv_list, attr.ohlcv, attr.data];
  for(const a of cands){
    if(Array.isArray(a) && a.length && Array.isArray(a[0]) && a[0].length>=5) return a;
  }
  return [];
}

/* ============ OHLCV 取得 ============ */
async function getDailyOHLCV_eth_pool(addr,{limit=120}={}){
  const wait=Math.max(0,lastGecko+GECKO_MIN_INTERVAL+geckoPenalty-Date.now()); if(wait>0)await sleep(wait+jitter());
  lastGecko=Date.now();
  for(let a=0;a<3;a++){
    try{
      const url=`https://api.geckoterminal.com/api/v2/networks/eth/pools/${addr}/ohlcv/day?aggregate=1&limit=${limit}`;
      const j=await getJsonSmart(url,{label:`OHLCV ${addr.slice(0,6)}…`});
      const arr=extractGeckoCandles(j);
      geckoPenalty=Math.max(0,geckoPenalty-100);
      return arr.map(x=>({ts:normTs(+x[0]),o:+x[1],h:+x[2],l:+x[3],c:+x[4],v:+x[5]}));
    }catch(e){
      const m=String(e.message||e);
      if(m.includes('429')){geckoPenalty=Math.min(3000,geckoPenalty+600); await sleep(1500+a*800); continue;}
      if(m.includes('abort')||m.includes('timeout')||m.includes('Load failed')){await sleep(1000+a*500); continue;}
      throw e;
    }
  }
}

/* ============ スパイク検出（可変ウィンドウ） ============ */
function bestSpikeFlexible(ohlc, windowDays, startTs, endTs){
  if(!ohlc?.length) return null;
  const sorted=[...ohlc].sort((a,b)=>a.ts-b.ts);
  const N=sorted.length, DAY=86400;
  let best=null, bestMult=0;

  for(let i=0;i<N;i++){
    const p=sorted[i];
    if(startTs && p.ts<startTs) continue;
    if(endTs && p.ts>endTs) continue;

    let j=i-1; if(j<0) continue;
    const lookbackTs=p.ts-windowDays*DAY;
    let minPrice=Infinity, minCandle=null;
    while(j>=0 && sorted[j].ts>=lookbackTs){
      const low=Math.min(sorted[j].l ?? sorted[j].c, sorted[j].c ?? sorted[j].l);
      if(low>0 && low<minPrice){minPrice=low; minCandle=sorted[j];}
      j--;
    }
    if(!minCandle) continue;
    const peakPrice=Math.max(p.h ?? p.c, p.c ?? p.h);
    if(!(peakPrice>0) || !(minPrice>0)) continue;

    const mult=peakPrice/minPrice;
    if(mult>bestMult){ bestMult=mult; best={ peak_ts:p.ts, pre_min_ts:minCandle.ts, multiple_14d:mult }; }
  }
  return best;
}

/* ============ Ethplorer（TopHolders） ============ */
const KNOWN_BURN_ADDRS=new Set(['0x0000000000000000000000000000000000000000','0x000000000000000000000000000000000000dead','0x000000000000000000000000000000000000dEaD']);
const LOCKER_HINTS=['unicrypt','team','pink','gempad','dxsale','mudra','safelock','bloxlock','trustswap','pinksale','deeplock','cryptex'];

async function getTopHolders_lp(tokenAddr,{apiKey='freekey'}={}) {
  if (!tokenAddr) return [];
  const baseUrl = `https://api.ethplorer.io/getTopTokenHolders/${tokenAddr}?apiKey=${encodeURIComponent(apiKey)}&limit=50`;

  let tries = 0, lastErr = null;
  while (tries < 8) {
    tries++;
    const wait = Math.max(0, lastEth + ETHPLORER_MIN_INTERVAL - Date.now());
    if (wait > 0) await sleep(wait + jitter(80, 280));
    lastEth = Date.now();

    try {
      const json = await getJsonSmart(baseUrl, { label: `TopHolders ${tokenAddr.slice(0,6)}…`, timeout: 14000 });
      const holders = json?.holders || [];
      return holders;
    } catch (e) {
      const msg = String(e.message || e);
      if (msg.includes('429')) {
        await sleep(2200 + tries * 600);
      } else if (msg.includes('timeout') || msg.includes('abort') || msg.includes('Load failed') || msg.includes('Failed to fetch') || msg.includes('NetworkError') || msg.includes('CORS')) {
        await sleep(1200 + tries * 400);
      } else if (msg.includes('400') || msg.includes('403') || msg.includes('406') || msg.includes('5')) {
        await sleep(1000 + tries * 300);
      }
      lastErr = e;
      log(`TopHolders再試行 ${tries}/8: ${msg}`, true);
    }
  }
  log('TopHolders: retries exhausted（LP%は unknown として続行）', true);
  return [];
}
function estimateLP(hs=[]){
  if(!hs.length) return {lp_pct_est:null,lp_type:'unknown',locker_name:'',burn_proof_url:'',locker_proof_url:''};
  let burn=0,lock=0,locker='';
  for(const h of hs){
    const addr=(h?.address||'').toLowerCase(); const name=(h?.owner?.name||h?.address||'').toLowerCase(); const share=+h?.share||0;
    if(KNOWN_BURN_ADDRS.has(addr)) burn+=share;
    else if(LOCKER_HINTS.some(k=>name.includes(k))){ lock+=share; if(!locker) locker=h?.owner?.name||h?.address; }
  }
  let typ='unknown'; if(burn>=1) typ='burn'; else if(lock>=1) typ='lp';
  return {lp_pct_est:+(burn+lock).toFixed(2),lp_type:typ,locker_name:locker||''};
}

/* ============ Google Trends ============ */
// ★ まずは Workers /series を使う（入力 trApi）
function stripXSSI(s){ return typeof s==='string' && s.startsWith(")]}',") ? s.slice(5) : s; }

async function getTrendsSeries({kw,geo,startTs,endTs,hl='ja',tz=0}){
  // スロットリング
  const wait=Math.max(0,lastTr+TRENDS_MIN_INTERVAL-Date.now());
  if(wait>0) await sleep(wait + jitter(80,260));
  lastTr=Date.now();

  const api = (by('trApi').value||'').trim();
  if (api) {
    // Workers /series にそのまま委譲
    const u = new URL(api);
    if (!u.pathname.endsWith('/series')) u.pathname = (u.pathname.replace(/\/+$/,'') || '') + '/series'; // 保険
    u.searchParams.set('kw', kw);
    u.searchParams.set('geo', geo || '');
    u.searchParams.set('hl', hl);
    u.searchParams.set('start', new Date(startTs*1000).toISOString().slice(0,10));
    u.searchParams.set('end', new Date((endTs-1)*1000).toISOString().slice(0,10));
    const r = await fetch(u.toString(), {mode:'cors'});
    if (!r.ok) throw new Error(`Series(worker) HTTP ${r.status}`);
    const j = await r.json();
    const pts = j?.points || [];
    return pts.map(p=>({ts: Math.floor(p.ts/1000), v: +p.value||0}));
  }

  // ★ フォールバック：直接叩く（textで受けて XSSI 除去 → JSON）
  const time = (()=> {
    const s=new Date(startTs*1000), e=new Date((endTs-1)*1000);
    const s9=`${s.getUTCFullYear()}-${String(s.getUTCMonth()+1).padStart(2,'0')}-${String(s.getUTCDate()).padStart(2,'0')}`;
    const e9=`${e.getUTCFullYear()}-${String(e.getUTCMonth()+1).padStart(2,'0')}-${String(e.getUTCDate()).padStart(2,'0')}`;
    return `${s9} ${e9}`;
  })();

  const exploreReq = { comparisonItem:[{keyword:kw, geo:geo||'', time}], category:0, property:'' };
  const base = 'https://trends.google.com/trends/api';
  const expURL = `${base}/explore?hl=${encodeURIComponent(hl)}&tz=${tz}&req=${encodeURIComponent(JSON.stringify(exploreReq))}`;

  const textFetch = async (url,label)=>{
    // 直接 or 汎用CORSプロキシ（順に試行）
    const user=by('cors').value.trim();
    const bases=[user||'', 'https://cors.isomorphic-git.org/', 'https://corsproxy.io/?url=', 'https://api.allorigins.win/raw?url='];
    let last;
    for(const b of bases){
      try{
        const u=buildProxiedUrl(b,url);
        log(`GET ${label}: ${u.slice(0,140)}`);
        const r=await fetch(u);
        const t=await r.text();              // ★ 常に text で取得
        if (!r.ok) { last=new Error(`HTTP ${r.status}`); continue; }
        if (/^\s*</.test(t)) { last=new Error('HTML response'); continue; } // ★ HTMLは即NG
        return t;
      }catch(e){ last=e; log(`…via ${b||'DIRECT'} failed: ${e.message||e}`,true); }
    }
    throw last||new Error('All proxies failed');
  };

  try{
    const expTxt = await textFetch(expURL, `Trends explore ${kw}`);
    const exp = JSON.parse(stripXSSI(expTxt));
    const widget=(exp.widgets||[]).find(w=>w?.id==='TIMESERIES'||w?.type==='TIMESERIES')||(exp.widgets||[]).find(w=>w?.type==='MULTILINE');
    if(!widget) throw new Error('TIMESERIES widget not found');
    const mlURL = `${base}/widgetdata/multiline?hl=${encodeURIComponent(hl)}&tz=${tz}&token=${encodeURIComponent(widget.token)}&req=${encodeURIComponent(JSON.stringify(widget.request))}`;
    const mlTxt = await textFetch(mlURL, `Trends data ${kw}`);
    const data = JSON.parse(stripXSSI(mlTxt));
    const series=((data?.default?.timelineData)||[]).map(d=>({ts:+d.time, v:+(d.value?.[0]??0)}));
    return series;
  }catch(e){
    throw new Error(`Trends fetch failed: ${e.message||e}`);
  }
}

function seriesToMapDaily(arr){const m=new Map(); for(const x of arr){ const d=new Date(x.ts*1000); const k=`${d.getUTCFullYear()}-${String(d.getUTCMonth()+1).padStart(2,'0')}-${String(d.getUTCDate()).padStart(2,'0')}`; m.set(k,+x.v); } return m;}
function ohlcToMapClose(arr){const m=new Map(); for(const x of arr){ const d=new Date(x.ts*1000); const k=`${d.getUTCFullYear()}-${String(d.getUTCMonth()+1).padStart(2,'0')}-${String(d.getUTCDate()).padStart(2,'0')}`; m.set(k,+x.c); } return m;}

/* 既存: 数値配列の%リターン */
function toReturns(vals){const out=[]; for(let i=1;i<vals.length;i++){ const a=vals[i-1], b=vals[i]; if(a>0 && b>0){ out.push((b/a-1)*100); } } return out; }
/* NaN維持版（日付整列を壊さない） */
function toReturnsSeries(vals){const out=[]; for(let i=1;i<vals.length;i++){ const a=vals[i-1], b=vals[i]; out.push(Number.isFinite(a)&&Number.isFinite(b)&&a>0&&b>0 ? (b/a-1)*100 : NaN);} return out;}

function alignAndLag(xArr,yArr,lag){ // lag>0: y を未来へ
  const n=Math.min(xArr.length, yArr.length);
  const xs=[], ys=[];
  if(lag===0){
    for(let i=0;i<n;i++){ const xi=xArr[i], yi=yArr[i]; if(Number.isFinite(xi)&&Number.isFinite(yi)){ xs.push(xi); ys.push(yi); } }
  }else if(lag>0){
    for(let i=lag;i<n;i++){ const xi=xArr[i], yi=yArr[i-lag]; if(Number.isFinite(xi)&&Number.isFinite(yi)){ xs.push(xi); ys.push(yi);} }
  }else{
    const L=-lag;
    for(let i=L;i<n;i++){ const xi=xArr[i-L], yi=yArr[i]; if(Number.isFinite(xi)&&Number.isFinite(yi)){ xs.push(xi); ys.push(yi);} }
  }
  return {xs,ys};
}
function pearson(xs,ys){
  const n=xs.length; if(n<3) return null;
  let sx=0, sy=0, sxx=0, syy=0, sxy=0;
  for(let i=0;i<n;i++){ const x=xs[i], y=ys[i]; sx+=x; sy+=y; sxx+=x*x; syy+=y*y; sxy+=x*y; }
  const cov=n*sxy - sx*sy, vx=Math.sqrt(n*sxx - sx*sx), vy=Math.sqrt(n*syy - sy*sy);
  return (vx>0 && vy>0) ? (cov/(vx*vy)) : null;
}

/* ============ Main ============ */
let LAST_ROWS=[]; let CANCEL=false; let CACHE_OHLCV=new Map(); // poolAddr -> candles
async function run(){
  CANCEL=false; by('cancelBtn').disabled=false;
  by('csvBtn').disabled=true; by('corrBtn').disabled=true; by('wrapTable').innerHTML=''; by('notes').innerHTML='';
  setBar(0); by('progress').textContent='preparing…';

  const days=+by('days').value||14, mult=+by('mult').value||3, lpmin=+by('lpmin').value||80, seedLimit=+by('seedLimit').value||20;
  const strict=by('strict').checked, lpRequired=by('lpRequired').checked, lpAfterMult=by('lpAfterMult').checked, showAll=by('showAll').checked;
  const ethKey=(by('ethKey')?.value||'freekey').trim();
  const {startTs,endTs}=datePrefToUnix();

  let ohlcLimit=120;
  if(startTs&&endTs&&endTs>startTs){
    const span=Math.ceil((endTs-startTs)/86400);
    ohlcLimit=Math.min(365, Math.max(span+days+15, 60));
  }

  by('params').textContent=[
    `Params: days=${days}, mult=${mult}, LP>=${lpmin}%, lpRequired=${lpRequired}, showAll=${showAll}`,
    `Period: start=${startTs||'-'} (${startTs?new Date(startTs*1000).toLocaleDateString():''}), end=${endTs||'-'} (${endTs?new Date(endTs*1000).toLocaleDateString():''})`,
    `Trends API: ${by('trApi').value||'(fallback: direct via proxies)'}`
  ].join('\n');

  try{
    log('トレンド取得開始');
    const {seeds,source}=await getTrendingSeeds({limit:seedLimit});
    const uniq=new Map(); for(const s of seeds) uniq.set(s.poolAddress.toLowerCase(),s);
    const seedArr=[...uniq.values()];
    log(`seed数: ${seedArr.length}（source: ${source}）`);
    if(seedArr.length===0){by('progress').textContent='seed=0'; setBar(0); return;}

    const rows=[]; let done=0;
    let tphOk=0,tphFail=0,tphSkip=0,ohlcvOk=0,ohlcvFail=0;

    for(const s of seedArr){
      if(CANCEL) throw new Error('cancelled');
      by('progress').textContent=`${done}/${seedArr.length} 取得中… ${s.name||''}`;
      log(`OHLCV/LP 取得: ${s.poolAddress}`); setBar(done/seedArr.length);

      let candles=[];
      try{
        candles=await getDailyOHLCV_eth_pool(s.poolAddress,{limit:ohlcLimit});
        CACHE_OHLCV.set(s.poolAddress, candles);
        ohlcvOk++;
        log(`ローソク本数: ${candles.length}｜最古: ${candles[0]?ts2(candles[0].ts):'-'}｜最新: ${candles[candles.length-1]?ts2(candles[candles.length-1].ts):'-'}`);
      }catch(e){log(`OHLCV失敗: ${e.message||e}`,true); ohlcvFail++;}

      const spike=bestSpikeFlexible(candles,days,startTs,endTs);
      const multV=spike?.multiple_14d||null;
      if(spike){log(`倍率サマリ: best×${fmt(multV)} at ${ts2(spike.peak_ts)}（min: ${ts2(spike.pre_min_ts)}）`);}
      else{log('倍率サマリ: 有効な上昇なし/データ不足');}

      // LPチェック
      let lpInfo={lp_pct_est:null,lp_type:'unknown',locker_name:''};
      let needLP=strict&&lpRequired;
      if(needLP && lpAfterMult && !(multV && multV>=mult)){ needLP=false; tphSkip++; log('TopHolders: skip (mult未達)'); }
      if(needLP){
        try{
          const token=s.tokenAddress||'';
          const hs=await getTopHolders_lp(token,{apiKey:ethKey});
          lpInfo=estimateLP(hs); tphOk++;
        }catch(e){log(`TopHolders失敗: ${e.message||e}`,true); tphFail++;}
      }

      let passes=true, reason=[];
      if(strict){
        if(!(multV && multV>=mult)){ passes=false; reason.push('mult'); }
        if(lpRequired && !(lpInfo.lp_pct_est!=null && lpInfo.lp_pct_est>=lpmin)){ passes=false; reason.push('lp'); }
      }

      const baseSym = (s.baseSymbol || (s.name||'').split('/')[0] || '').trim();
      const trendKw = baseSym ? `${baseSym} crypto` : '';

      rows.push({
        token_pool:s.name||'', address:s.poolAddress, token_address:s.tokenAddress||'',
        base_symbol: baseSym, trend_kw: trendKw,
        multiple_14d_close:multV?fmt(multV):'',
        peak_ts:spike?.peak_ts||'', pre14_min_ts:spike?.pre_min_ts||'',
        lp_pct_est:lpInfo.lp_pct_est??'', lp_type:lpInfo.lp_type, locker_name:lpInfo.locker_name||'',
        tr_r_max:'', tr_lag_best:'', tr_r0:'', tr_link:'',
        dex_url:`https://dexscreener.com/ethereum/${s.poolAddress}`,
        gecko_ohlcv_url:`https://api.geckoterminal.com/api/v2/networks/eth/pools/${s.poolAddress}/ohlcv/day?aggregate=1&limit=${ohlcLimit}`,
        ethplorer_token_url:s.tokenAddress?`https://ethplorer.io/address/${s.tokenAddress}`:'',
        __passes:passes, __reason:reason.join(',')
      });

      done++; setBar(done/seedArr.length);
    }

    render(rows,{strict,lpmin,showAll});
    LAST_ROWS=rows;
    const shown=(strict&&!showAll)?rows.filter(r=>r.__passes).length:rows.length;
    by('progress').textContent=`完了: ${shown} rows（total ${rows.length}）`;
    by('csvBtn').disabled=rows.length===0;
    by('corrBtn').disabled=rows.length===0;
    log(`要約: OHLCV 成功 ${ohlcvOk}/失敗 ${ohlcvFail}｜TopHolders 成功 ${tphOk}/失敗 ${tphFail}｜skip ${tphSkip}`);
    log('スキャン完了');
  }catch(e){
    if(String(e)==='Error: cancelled'){log('ユーザーがキャンセルしました'); by('progress').textContent='cancelled';}
    else{log(`致命的エラー: ${e.message||e}`,true); by('progress').textContent='error';}
  }finally{setBar(1); by('cancelBtn').disabled=true;}
}

/* ============ 相関（Google Trends） ============ */
async function runCorrelation(){
  if(!LAST_ROWS.length) return;
  const {startTs,endTs}=datePrefToUnix();
  const geo=by('trGeo').value; const L=+by('trLag').value||7; const mode=by('trMode').value;

  let idx=0;
  for(const r of LAST_ROWS){
    idx++; if(!r.trend_kw){ continue; }
    by('progress').textContent=`Trends: ${idx}/${LAST_ROWS.length} ${r.trend_kw}`;
    try{
      const candles=CACHE_OHLCV.get(r.address)||[];
      const priceMap=ohlcToMapClose(candles);
      // 日付配列（スキャン期間と重なる部分）
      const dates=[]; for(let t=startTs;t<endTs;t+=86400){ const d=new Date(t*1000); dates.push(`${d.getUTCFullYear()}-${String(d.getUTCMonth()+1).padStart(2,'0')}-${String(d.getUTCDate()).padStart(2,'0')}`); }

      const trSeries=await getTrendsSeries({kw:r.trend_kw,geo,startTs,endTs,hl:'ja',tz:0});
      const trendMap=seriesToMapDaily(trSeries);

      let px=[], tv=[];
      for(const d of dates){ const p=priceMap.get(d), v=trendMap.get(d); px.push(Number.isFinite(p)?p:NaN); tv.push(Number.isFinite(v)?v:NaN); }
      // 欠損埋め：前日値を持ち越し
      for(let i=1;i<px.length;i++){ if(!Number.isFinite(px[i])&&Number.isFinite(px[i-1])) px[i]=px[i-1]; }
      for(let i=1;i<tv.length;i++){ if(!Number.isFinite(tv[i])&&Number.isFinite(tv[i-1])) tv[i]=tv[i-1]; }

      if(mode==='ret'){ px=toReturnsSeries(px); tv=toReturnsSeries(tv); }

      // ラグ探索
      let bestR=null, bestLag=0, r0=null;
      for(let lag=-L; lag<=L; lag++){
        const {xs,ys}=alignAndLag(px,tv,lag);
        const rr=pearson(xs,ys);
        if(lag===0) r0=rr;
        if(rr!=null && (bestR==null || Math.abs(rr)>Math.abs(bestR))){ bestR=rr; bestLag=lag; }
      }

      r.tr_r_max = (bestR==null)?'':fmt(bestR);
      r.tr_lag_best = (bestR==null)?'':bestLag;
      r.tr_r0 = (r0==null)?'':fmt(r0);
      const s=new Date(startTs*1000), e=new Date((endTs-1)*1000);
      const tf=`${s.getUTCFullYear()}-${String(s.getUTCMonth()+1).padStart(2,'0')}-${String(s.getUTCDate()).padStart(2,'0')} ${e.getUTCFullYear()}-${String(e.getUTCMonth()+1).padStart(2,'0')}-${String(e.getUTCDate()).padStart(2,'0')}`;
      r.tr_link = `https://trends.google.com/trends/explore?q=${encodeURIComponent(r.trend_kw)}&geo=${encodeURIComponent(geo)}&date=${tf}`;

      log(`Trends相関: ${r.trend_kw} → r_max=${r.tr_r_max} (lag=${r.tr_lag_best}) r0=${r.tr_r0}`);
    }catch(e){
      log(`Trends取得失敗: ${r.trend_kw}｜${e.message||e}`,true);
    }
    // ★ 呼び出し間ディレイで 429/403 をさらに回避
    await sleep(300 + Math.random()*200);
  }
  render(LAST_ROWS,{strict:by('strict').checked,lpmin:+by('lpmin').value||80,showAll:by('showAll').checked});
  by('progress').textContent='相関計算 完了';
}

/* ============ 表示 ============ */
function render(rows,{strict,lpmin,showAll}){
  const show=(strict && !showAll)?rows.filter(r=>r.__passes):rows;
  let h=`<table><thead><tr>
    <th>#</th><th>Token/Pool</th><th>Pool</th><th>Token</th>
    <th>multiple(14d)</th><th>peak_ts</th><th>pre14_min_ts</th>
    <th>LP% (est)</th><th>LP type</th><th>locker</th>
    <th>Trend KW</th><th>r_max(±lag)</th><th>lag_best(d)</th><th>r0</th>
    <th>Links</th>
  </tr></thead><tbody>`;
  show.forEach((r,i)=>{
    const m=+r.multiple_14d_close||0;
    const mcls=m>=3?'good':(m>=2?'warn':'');
    const lpcls=(r.lp_pct_est>=lpmin)?'good':(r.lp_pct_est>=50?'warn':'bad');
    h+=`<tr class="token" data-symbol="${(r.base_symbol||'').toLowerCase()}">
      <td class="num">${i+1}</td>
      <td>${r.token_pool||''}</td>
      <td><a href="${r.dex_url}" target="_blank">${r.address.slice(0,6)}…${r.address.slice(-4)}</a></td>
      <td>${r.token_address?`<a href="${r.ethplorer_token_url}" target="_blank">${r.token_address.slice(0,6)}…${r.token_address.slice(-4)}</a>`:''}</td>
      <td class="num ${mcls}">${r.multiple_14d_close||''}</td>
      <td class="num">${r.peak_ts?ts2(r.peak_ts):''}</td>
      <td class="num">${r.pre14_min_ts?ts2(r.pre14_min_ts):''}</td>
      <td class="num ${lpcls}">${r.lp_pct_est!==''?fmt(r.lp_pct_est)+'%':''}</td>
      <td>${r.lp_type||''}</td>
      <td>${r.locker_name||''}</td>
      <td>${r.trend_kw||''}</td>
      <td class="num corr">${r.tr_r_max||''}</td>
      <td class="num">${r.tr_lag_best||''}</td>
      <td class="num">${r.tr_r0||''}</td>
      <td>
        <a href="${r.dex_url}" target="_blank">Dex</a> /
        <a href="${r.gecko_ohlcv_url}" target="_blank">OHLCV</a>
        ${r.ethplorer_token_url?` / <a href="${r.ethplorer_token_url}" target="_blank">Ethplorer</a>`:''}
        ${r.tr_link?` / <a href="${r.tr_link}" target="_blank">Trends</a>`:''}
      </td>
    </tr>`;
  });
  h+='</tbody></table>'; by('wrapTable').innerHTML=h;
}

/* ============ UI ============ */
by('runBtn').addEventListener('click',run);
by('corrBtn').addEventListener('click',runCorrelation);
by('cancelBtn').addEventListener('click',()=>{CANCEL=true; by('cancelBtn').disabled=true;});
by('csvBtn').addEventListener('click',()=>{if(!LAST_ROWS.length)return; const name=`meme_trending_eth_${Date.now()}.csv`; const out=LAST_ROWS.map(({__passes,__reason,...rest})=>rest); dl(name,toCSV(out));});
</script>
</body>
</html>
