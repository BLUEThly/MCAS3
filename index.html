<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ミームコイン自動スクリーニング（ETH）— 厳密モード＋カレンダー期間</title>
<style>
  :root{
    --bg:#0f172a; --panel:#0b1220; --text:#e5e7eb; --muted:#9ca3af;
    --good:#22c55e; --bad:#ef4444; --warn:#f59e0b; --link:#93c5fd;
    --chip:#1f2937; --table:#0b1220; --border:#1f2937; --btn:#1d4ed8;
  }
  html,body{background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,Segoe UI,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";margin:0}
  header{padding:18px 14px;border-bottom:1px solid var(--border);background:var(--panel)}
  h1{font-size:16px;margin:0 0 10px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:end}
  .ctl{display:flex;flex-direction:column;gap:6px}
  label{font-size:12px;color:var(--muted)}
  input,select,button{background:#0f172a;border:1px solid #293145;color:var(--text);padding:8px 10px;border-radius:8px;font-size:14px}
  input[type="checkbox"]{width:auto}
  button{cursor:pointer}
  button.primary{background:var(--btn);border-color:var(--btn)}
  button.ghost{background:var(--panel)}
  button.red{background:#7f1d1d;border-color:#7f1d1d}
  .pill{background:var(--chip);padding:6px 10px;border-radius:999px;color:#cbd5e1;font-size:12px}
  main{padding:16px}
  .log{white-space:pre-wrap;background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:10px;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .log .err{color:var(--bad)}
  table{width:100%;border-collapse:separate;border-spacing:0 6px}
  thead th{font-size:12px;color:#9ca3af;text-align:left;padding:6px 8px}
  tbody tr{background:var(--table)}
  td{padding:8px 8px;font-size:13px;border-top:1px solid var(--border);border-bottom:1px solid var(--border)}
  tbody tr td:first-child{border-left:1px solid var(--border);border-radius:8px 0 0 8px}
  tbody tr td:last-child{border-right:1px solid var(--border);border-radius:0 8px 8px 0}
  a{color:var(--link);text-decoration:none}
  .num{font-variant-numeric:tabular-nums}
  .good{color:var(--good)} .bad{color:var(--bad)} .warn{color:var(--warn)}
  footer{opacity:.7;margin-top:16px;font-size:12px}
  .bar{height:8px;background:#0a1a38;border:1px solid #1f2b45;border-radius:999px;overflow:hidden}
  .bar > div{height:100%;width:0;background:#2563eb;transition:width .2s}
  details{margin-top:6px}
</style>
</head>
<body>
<header>
  <h1>ミームコイン自動スクリーニング（ETH）— 厳密モード＋カレンダー期間</h1>

  <div class="row">
    <div class="ctl"><label>days（急騰検出の直近日数）</label><input id="days" type="number" value="14" min="7" max="30"></div>
    <div class="ctl"><label>mult（ピーク/直前minの倍率）</label><input id="mult" type="number" value="3" min="1.2" step="0.1"></div>
    <div class="ctl"><label>LP% しきい値（burn/locker合算）</label><input id="lpmin" type="number" value="80" min="0" max="100"></div>
    <div class="ctl"><label>Trending 種（上限）</label><input id="seedLimit" type="number" value="20" min="5" max="100"></div>
    <div class="ctl"><label>厳密モード</label><div><input id="strict" type="checkbox" checked> <span class="pill">days×mult と LP% フィルタを適用</span></div></div>
    <div class="ctl"><label>LP%必須</label><div><input id="lpRequired" type="checkbox" checked> <span class="pill">LP%が取れない行は除外</span></div></div>
  </div>

  <div class="row" style="margin-top:8px">
    <div class="ctl">
      <label>抽出期間（開始, カレンダー）</label>
      <input id="dateStart" type="date" />
    </div>
    <div class="ctl">
      <label>抽出期間（終了, カレンダー）</label>
      <input id="dateEnd" type="date" />
    </div>
    <div class="ctl" style="flex:1">
      <label>（任意）CORS プロキシ</label>
      <input id="cors" placeholder="空でも可／例: https://<your-worker>.workers.dev/?url=">
    </div>
    <div class="ctl">
      <label>&nbsp;</label>
      <div style="display:flex;gap:8px">
        <button class="primary" id="runBtn" type="button">スキャン実行</button>
        <button class="red" id="cancelBtn" type="button" disabled>キャンセル</button>
        <button class="ghost" id="csvBtn" type="button" disabled>CSV</button>
      </div>
    </div>
  </div>

  <details>
    <summary style="cursor:pointer;color:#cbd5e1">詳細設定（UNIX秒による期間指定・既定は空）</summary>
    <div class="row" style="margin-top:6px">
      <div class="ctl"><label>開始（UNIX秒）</label><input id="startTs" placeholder="例: 1754006400"></div>
      <div class="ctl"><label>終了（UNIX秒）</label><input id="endTs" placeholder="例: 1758067200"></div>
    </div>
  </details>
</header>

<main>
  <div id="params" class="log" style="margin-bottom:10px">待機中：上のパラメータをセットして「スキャン実行」を押してください。</div>

  <div class="bar"><div id="pbar"></div></div>
  <div style="height:8px"></div>
  <div class="pill" id="progress">idle</div>

  <div style="height:10px"></div>
  <div class="log" id="notes"></div>
  <div style="height:14px"></div>
  <div id="wrapTable"></div>

  <footer>© 2025 — Ethereum only｜データ: GeckoTerminal（日足OHLCV）/ DexScreener（トレンド補助）/ Ethplorer（TopHolders）</footer>
</main>

<script>
/* ===== Utilities ===== */
const by = (id)=>document.getElementById(id);
const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
const ts2 = (t)=> new Date(t*1000).toLocaleString();
const fmtNum = (x,d=2)=> (x==null||Number.isNaN(+x))?'':(+x).toFixed(d);
const jitter = (min=120,max=420)=> Math.floor(Math.random()*(max-min+1))+min;

function log(msg, isErr=false){
  const el = by('notes');
  const line = `[${new Date().toLocaleTimeString()}] ${msg}`;
  el.innerHTML += (isErr? `<div class="err">${line}</div>` : `<div>${line}</div>`);
  el.scrollTop = el.scrollHeight;
}
function setBar(f01){ by('pbar').style.width = `${Math.max(0,Math.min(1,f01))*100}%`; }

/* ===== CORS（自動判別＋フォールバック） ===== */
function buildProxiedUrl(base, url){
  if(!base) return url;
  const b = base.trim();
  if(/\{url\}/i.test(b)) return b.replace(/\{url\}/ig, encodeURIComponent(url));
  if(/[\?&]url=$/i.test(b) || (/\?$/.test(b) && /url=/.test(b))) return b + encodeURIComponent(url);
  if(/[\?&]url=\/$/.test(b)) return b.replace(/\/$/, '') + encodeURIComponent(url);
  return b.replace(/\/+$/,'') + '/' + url;
}
async function _fetchJson(u, {timeout=12000, label='' }={}){
  const controller = new AbortController();
  const tid = setTimeout(()=>controller.abort('timeout'), timeout);
  try{
    if(label) log(`GET ${label}: ${u.slice(0,140)}`);
    const res = await fetch(u, {signal: controller.signal});
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const ct = (res.headers.get('content-type')||'').toLowerCase();
    if(ct.includes('application/json')){ clearTimeout(tid); return await res.json(); }
    const txt = await res.text(); clearTimeout(tid);
    try{ return JSON.parse(txt); }catch(_){ throw new Error(`Non-JSON body (${txt.slice(0,80)}…)`); }
  }catch(e){ clearTimeout(tid); throw e; }
}
async function getJson(url, {label='', timeout=12000}={}){
  const userBase = by('cors').value.trim();
  const bases = [
    '',                                    // 1. 直
    userBase || null,                      // 2. ユーザー指定
    'https://cors.isomorphic-git.org/',    // 3. prefix型
    'https://corsproxy.io/?url=',          // 4. ?url=型
    'https://api.allorigins.win/raw?url='  // 5. ?url=型
  ].filter(Boolean);
  let lastErr;
  for(const b of bases){
    const u = buildProxiedUrl(b, url);
    try{ return await _fetchJson(u, {timeout, label}); }
    catch(e){ lastErr = e; log(`…via ${b||'DIRECT'} failed: ${e.message||e}`, true); }
  }
  throw lastErr;
}

/* ===== CSV ===== */
function toCSV(rows){
  const esc = (v)=> v==null ? '' : /[",\n]/.test(String(v))?`"${String(v).replace(/"/g,'""')}"`:String(v);
  const header = Object.keys(rows[0]||{});
  const out = [header.map(esc).join(',')];
  for(const r of rows){ out.push(header.map(k=>esc(r[k])).join(',')); }
  return out.join('\n');
}
function dl(name, text){
  const blob = new Blob([text], {type:'text/csv'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob); a.download = name; a.click();
  URL.revokeObjectURL(a.href);
}

/* ===== Dates -> UNIX (local) ===== */
function dateToStartUnix(s){ if(!s) return null; const d=new Date(s+'T00:00:00'); return Math.floor(d.getTime()/1000); }
function dateToEndUnix(s){ if(!s) return null; const d=new Date(s+'T23:59:59'); return Math.floor(d.getTime()/1000)+1; }

/* ===== レート制御（429対策） ===== */
let lastEthCall = 0, lastGeckoCall = 0;
const ETHPLORER_MIN_INTERVAL = 2800; // 2.8s/req（強め）
const GECKO_MIN_INTERVAL     =  700; // 0.7s/req

/* ===== Trending ===== */
async function getTrendingSeeds({limit=20}){
  try{
    const j = await getJson(`https://api.geckoterminal.com/api/v2/networks/eth/trending_pools?page=1`, {label:'Gecko trending'});
    const arr = (j?.data||[]).slice(0,limit);
    const pools = arr.map(x=>({
      poolAddress: x?.attributes?.address,
      base: x?.relationships?.base_token?.data?.id?.split('_').slice(2).join('_') || '',
      quote: x?.relationships?.quote_token?.data?.id?.split('_').slice(2).join('_') || '',
      name: x?.attributes?.name || ''
    })).filter(x=>x.poolAddress);
    if(pools.length){ log(`Gecko trending: ${pools.length} seeds`); return {seeds:pools, source:'GeckoTerminal'}; }
  }catch(e){ log(`Gecko trending failed: ${e.message||e}`, true); }
  const j2 = await getJson(`https://api.dexscreener.com/latest/dex/trending?limit=${limit}`, {label:'DexScreener trending'});
  const seeds = (j2?.pairs||[]).filter(p=> (p.chainId==='ethereum'||p.chainId==='eth') ).slice(0,limit).map(p=>({
    poolAddress: p.pairAddress,
    base: p.baseToken?.symbol||'',
    quote: p.quoteToken?.symbol||'',
    name: p.baseToken?.symbol && p.quoteToken?.symbol ? `${p.baseToken.symbol}/${p.quoteToken.symbol}` : (p.symbol||'')
  }));
  log(`DexScreener trending: ${seeds.length} seeds`);
  return {seeds, source:'DexScreener'};
}

/* ===== OHLCV（日足）＆ 14日スパイク ===== */
async function getDailyOHLCV_eth_pool(poolAddress, {limit=120}={}){
  const wait = Math.max(0, lastGeckoCall + GECKO_MIN_INTERVAL - Date.now());
  if (wait > 0) await sleep(wait + jitter());
  lastGeckoCall = Date.now();

  for(let a=0;a<3;a++){
    try{
      const j = await getJson(`https://api.geckoterminal.com/api/v2/networks/eth/pools/${poolAddress}/ohlcv/day?aggregate=1&limit=${limit}`, {label:`OHLCV ${poolAddress.slice(0,6)}…`});
      const arr = j?.data?.attributes?.candles || [];
      return arr.map(x=>({ts:+x[0], o:+x[1], h:+x[2], l:+x[3], c:+x[4], v:+x[5]}));
    }catch(e){
      const msg = String(e.message||e);
      if(msg.includes('429')){ await sleep(1500 + a*800); continue; }
      throw e;
    }
  }
  throw new Error('OHLCV: retries exhausted');
}
function computeSpike14(ohlc, days=14){
  if(!ohlc?.length) return null;
  const sorted=[...ohlc].sort((a,b)=>a.ts-b.ts);
  const lastN=sorted.slice(-days);
  if(lastN.length<Math.max(5,Math.floor(days*0.6))) return null;
  let peakIdx=-1,peakClose=-Infinity;
  lastN.forEach((c,i)=>{ if(c.c>peakClose){peakClose=c.c; peakIdx=i;}});
  const peak=lastN[peakIdx], peakTs=peak.ts;
  const gi=sorted.findIndex(c=>c.ts===peakTs);
  const preWin=sorted.slice(Math.max(0,gi-days), gi);
  if(!preWin.length) return null;
  let minClose=Infinity, minC=null; preWin.forEach(c=>{ if(c.c<minClose){minClose=c.c; minC=c;} });
  return {
    peak_ts: peakTs, peak_close: peakClose,
    pre14_min_ts: minC?.ts||null, pre14_min_close: minClose||null,
    multiple_14d_close: (minClose>0)? peakClose/minClose : null
  };
}

/* ===== LP holders（Ethplorer） ===== */
const KNOWN_BURN_ADDRS=new Set(['0x0000000000000000000000000000000000000000','0x000000000000000000000000000000000000dead','0x000000000000000000000000000000000000dEaD']);
const LOCKER_HINTS=['unicrypt','team','pink','gempad','dxsale','mudra','safelock','bloxlock','trustswap','pinksale','deeplock','cryptex'];

async function getTopHolders_lp(lpAddress){
  // Ethplorer は公開プロキシ経由だと 400/406 が出やすいので、
  // ユーザー指定CORS（Workers等）がある場合はそれを優先して使う。
  const userBase = by('cors').value.trim();
  const build = (suf)=> (userBase? buildProxiedUrl(userBase, `https://api.ethplorer.io/${suf}`) : `https://api.ethplorer.io/${suf}`);

  for (let attempt=0; attempt<6; attempt++){
    const wait = Math.max(0, lastEthCall + ETHPLORER_MIN_INTERVAL - Date.now());
    if (wait > 0) await sleep(wait + jitter());
    lastEthCall = Date.now();

    const url = build(`getTopTokenHolders/${lpAddress}?apiKey=freekey&limit=50`);
    try{
      const j = await _fetchJson(url, {label:`TopHolders ${lpAddress.slice(0,6)}…`});
      return j?.holders || [];
    }catch(e){
      const msg = String(e.message||e);
      // 429 は待って再試行、400/406 でもプロキシが落ち着くと返るケースあり
      if (msg.includes('429')) { await sleep(2200 + attempt*600); continue; }
      if (msg.includes('400') || msg.includes('406') || msg.includes('Load failed') || msg.includes('Failed to fetch') || msg.includes('timeout')) {
        await sleep(1400 + attempt*500); continue;
      }
      throw e;
    }
  }
  throw new Error('TopHolders: retries exhausted');
}

function estimateLP(hs=[]){
  if(!hs.length) return {lp_pct_est:null, lp_type:'unknown', locker_name:'', burn_proof_url:'', locker_proof_url:''};
  let burnPct=0,lockPct=0,topLocker='';
  for(const h of hs){
    const addr=(h?.address||'').toLowerCase(); const name=(h?.owner?.name||h?.address||'').toLowerCase(); const share=+h?.share||0;
    if(KNOWN_BURN_ADDRS.has(addr)) burnPct+=share;
    else if(LOCKER_HINTS.some(k=>name.includes(k))){ lockPct+=share; if(!topLocker) topLocker=h?.owner?.name||h?.address; }
  }
  let lp_type='unknown'; if(burnPct>=1) lp_type='burn'; else if(lockPct>=1) lp_type='lp';
  const url=(a)=>`https://ethplorer.io/address/${a}`;
  const bh=hs.find(h=> KNOWN_BURN_ADDRS.has((h.address||'').toLowerCase()) );
  const lh=hs.find(h=> LOCKER_HINTS.some(k=> ((h.owner?.name||h.address||'').toLowerCase().includes(k)) ) );
  return {lp_pct_est:+(burnPct+lockPct).toFixed(2), lp_type, locker_name:topLocker||'', burn_proof_url:bh?url(bh.address):'', locker_proof_url:lh?url(lh.address):''};
}

/* ===== Main ===== */
let LAST_ROWS=[]; let CANCEL=false;

function datePrefToUnix(){
  let startTs = dateToStartUnix(by('dateStart').value);
  let endTs = dateToEndUnix(by('dateEnd').value);
  if(by('startTs').value) startTs = +by('startTs').value;
  if(by('endTs').value) endTs = +by('endTs').value;
  return {startTs,endTs};
}

async function run(){
  CANCEL=false; by('cancelBtn').disabled=false;
  by('csvBtn').disabled=true; by('wrapTable').innerHTML=''; by('notes').innerHTML='';
  setBar(0); by('progress').textContent='preparing…';

  const days=+by('days').value||14, mult=+by('mult').value||3, lpmin=+by('lpmin').value||80, seedLimit=+by('seedLimit').value||20;
  const strict=by('strict').checked, lpRequired=by('lpRequired').checked;
  const {startTs,endTs}=datePrefToUnix();

  by('params').textContent=[
    `Params: days=${days}, mult=${mult}, LP>=${lpmin}%, lpRequired=${lpRequired}`,
    `Period: start=${startTs||'-'} (${startTs?new Date(startTs*1000).toLocaleDateString():''}), end=${endTs||'-'} (${endTs?new Date(endTs*1000).toLocaleDateString():''})`
  ].join('\n');

  try{
    log('トレンド取得開始');
    const {seeds,source} = await getTrendingSeeds({limit:seedLimit});
    if(CANCEL) throw new Error('cancelled');
    const uniq=new Map(); for(const s of seeds){ uniq.set(s.poolAddress.toLowerCase(), s); }
    const seedArr=[...uniq.values()];
    log(`seed数: ${seedArr.length}（source: ${source}）`);
    if(seedArr.length===0){ by('progress').textContent='seed=0'; setBar(0); return; }

    const rows=[]; let done=0;
    let tphOk=0, tphFail=0, ohlcvOk=0, ohlcvFail=0;

    for(const s of seedArr){
      if(CANCEL) throw new Error('cancelled');
      by('progress').textContent=`${done}/${seedArr.length} 取得中… ${s.name||''}`;
      log(`OHLCV/LP 取得: ${s.poolAddress}`);
      setBar(done/seedArr.length);

      // OHLCV
      let candles=[];
      try{ candles = await getDailyOHLCV_eth_pool(s.poolAddress,{limit:120}); ohlcvOk++; }
      catch(e){ log(`OHLCV失敗: ${e.message||e}`,true); ohlcvFail++; }
      if(startTs||endTs){
        candles = candles.filter(c=> (!startTs||c.ts>=startTs) && (!endTs||c.ts<=endTs) );
      }
      const spike = computeSpike14(candles, days);

      // LP
      let lpInfo={lp_pct_est:null, lp_type:'unknown', locker_name:'', burn_proof_url:'', locker_proof_url:''};
      try{ const hs=await getTopHolders_lp(s.poolAddress); lpInfo=estimateLP(hs); tphOk++; }
      catch(e){ log(`TopHolders失敗: ${e.message||e}`,true); tphFail++; }

      // 判定
      const multV=spike?.multiple_14d_close||null;
      let passes=true, reason=[];
      if(strict){
        if(!(multV && multV>=mult)) { passes=false; reason.push('mult'); }
        if(lpRequired){
          if(!(lpInfo.lp_pct_est!=null && lpInfo.lp_pct_est>=lpmin)) { passes=false; reason.push('lp'); }
        }
      }

      rows.push({
        token_pool: s.name || (s.base&&s.quote?`${s.base}/${s.quote}`:''), address:s.poolAddress,
        peak_ts:spike?.peak_ts||'', peak_close:spike?.peak_close||'',
        pre14_min_ts:spike?.pre14_min_ts||'', pre14_min_close:spike?.pre14_min_close||'',
        multiple_14d_close: multV?multV.toFixed(2):'',
        lp_type:lpInfo.lp_type, lp_pct_est:lpInfo.lp_pct_est??'', locker_name:lpInfo.locker_name||'',
        start_ts:startTs||'', end_ts:endTs||'',
        data_mode: strict?'strict':'gecko-only',
        dex_url:`https://dexscreener.com/ethereum/${s.poolAddress}`,
        gecko_ohlcv_url:`https://api.geckoterminal.com/api/v2/networks/eth/pools/${s.poolAddress}/ohlcv/day?aggregate=1&limit=120`,
        ethplorer_token_url:`https://ethplorer.io/address/${s.poolAddress}`,
        burn_proof_url:lpInfo.burn_proof_url||'', locker_proof_url:lpInfo.locker_proof_url||'',
        __passes:passes, __reason:reason.join(',')
      });

      done++; setBar(done/seedArr.length);
    }

    renderTable(rows,{strict, lpmin});
    LAST_ROWS=rows;
    const shown = strict ? rows.filter(r=>r.__passes).length : rows.length;
    by('progress').textContent = `完了: ${shown} hits（total ${rows.length}）`;
    by('csvBtn').disabled = rows.length===0;
    log(`要約: OHLCV 成功 ${ohlcvOk}/失敗 ${ohlcvFail}｜TopHolders 成功 ${tphOk}/失敗 ${tphFail}`);
    log('スキャン完了');
  }catch(e){
    if(String(e)==='Error: cancelled'){ log('ユーザーがキャンセルしました'); by('progress').textContent='cancelled'; }
    else{ log(`致命的エラー: ${e.message||e}`, true); by('progress').textContent='error'; }
  }finally{
    setBar(1); by('cancelBtn').disabled=true;
  }
}

function renderTable(rows,{strict, lpmin}){
  const show = strict ? rows.filter(r=>r.__passes) : rows;
  let html = `<table><thead>
    <tr>
      <th>#</th><th>Token/Pool</th><th>Address</th>
      <th>multiple(14d)</th><th>peak_ts</th><th>pre14_min_ts</th>
      <th>LP% (est)</th><th>LP type</th><th>locker</th><th>Links</th>
    </tr></thead><tbody>`;
  show.forEach((r,i)=>{
    const m=+r.multiple_14d_close||0;
    const mcls = m>=3?'good':(m>=2?'warn':'');
    const lpcls = (r.lp_pct_est>=lpmin)?'good':(r.lp_pct_est>=50?'warn':'bad');
    html += `<tr>
      <td class="num">${i+1}</td>
      <td>${r.token_pool||''}</td>
      <td><a href="${r.dex_url}" target="_blank">${r.address.slice(0,6)}…${r.address.slice(-4)}</a></td>
      <td class="num ${mcls}">${r.multiple_14d_close||''}</td>
      <td class="num">${r.peak_ts?ts2(r.peak_ts):''}</td>
      <td class="num">${r.pre14_min_ts?ts2(r.pre14_min_ts):''}</td>
      <td class="num ${lpcls}">${r.lp_pct_est!==''?fmtNum(r.lp_pct_est,2)+'%':''}</td>
      <td>${r.lp_type}</td>
      <td>${r.locker_name||''}</td>
      <td>
        <a href="${r.dex_url}" target="_blank">Dex</a> /
        <a href="${r.gecko_ohlcv_url}" target="_blank">OHLCV</a> /
        <a href="${r.ethplorer_token_url}" target="_blank">Ethplorer</a>
      </td>
    </tr>`;
  });
  html += `</tbody></table>`;
  by('wrapTable').innerHTML = html;
}

/* ===== UI ===== */
by('runBtn').addEventListener('click', run);
by('cancelBtn').addEventListener('click', ()=>{ CANCEL=true; by('cancelBtn').disabled=true; });
by('csvBtn').addEventListener('click', ()=>{
  if(!LAST_ROWS.length) return;
  const now = new Date();
  const name = `meme_trending_eth_${now.getTime()}.csv`;
  const out = LAST_ROWS.map(({__passes,__reason,...rest})=>rest);
  dl(name, toCSV(out));
});
</script>
</body>
</html>
