<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>新規ミームコイン データ収集・分析支援（Ethereum）- latest</title>
  <style>
    :root { color-scheme: dark light; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 16px; line-height: 1.45; }
    h1 { font-size: 20px; margin: 0 0 12px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; max-width: 1100px; }
    label { display: block; font-size: 12px; color: #8aa1b1; margin-bottom: 6px; }
    input[type="text"], input[type="date"], input[type="number"] { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #444; background: transparent; color: inherit; }
    .row { grid-column: span 2; }
    .actions { display: flex; gap: 12px; margin: 16px 0; }
    button { padding: 10px 16px; border-radius: 8px; border: 1px solid #555; background: #2d6cdf; color: #fff; cursor: pointer; }
    button.secondary { background: transparent; color: inherit; }
    #log { white-space: pre-wrap; background: #111; border: 1px solid #333; border-radius: 8px; padding: 10px; min-height: 140px; overflow: auto; max-width: 1100px; }
    table { border-collapse: collapse; width: 100%; margin-top: 12px; }
    th, td { border-bottom: 1px solid #333; padding: 8px; font-size: 13px; vertical-align: top; }
    th { position: sticky; top: 0; background: #0b0b0b; }
    .muted { color: #8aa1b1; font-size: 12px; }
    code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; }
  </style>
</head>
<body>
  <h1>新規ミームコイン データ収集・分析支援 <span class="muted">(Ethereum / latest)</span></h1>

  <section class="grid">
    <div>
      <label>観測期間の開始日</label>
      <input type="date" id="startDate" />
    </div>
    <div>
      <label>観測期間の終了日</label>
      <input type="date" id="endDate" />
    </div>
    <div>
      <label>急騰判定 期間（日）</label>
      <input type="number" id="pumpDays" value="14" min="1" step="1" />
    </div>
    <div>
      <label>急騰判定 倍率（x）</label>
      <input type="number" id="pumpMult" value="3" min="1" step="0.1" />
    </div>
    <div>
      <label>LPロック閾値（%）</label>
      <input type="number" id="lpThreshold" value="80" min="0" max="100" step="1" />
    </div>
    <div>
      <label>最大表示件数（UIのみ）</label>
      <input type="number" id="maxRows" value="150" min="10" step="10" />
    </div>
    <div class="row">
      <label>(任意) Cloudflare Workers プロキシURL</label>
      <input type="text" id="workerUrl" placeholder="https://YOUR-NAME.workers.dev/?url=" />
      <small class="muted">モバイルアプリ内WebView等でCORSが強い場合に設定（保存されます）。</small>
    </div>
  </section>

  <section class="actions">
    <button id="runBtn">分析開始</button>
    <button id="csvBtn" class="secondary" disabled>CSVをダウンロード</button>
  </section>

  <div id="log" aria-live="polite"></div>

  <table id="tbl" style="display:none">
    <thead>
      <tr>
        <th>#</th>
        <th>Token</th>
        <th>Address</th>
        <th>Pool</th>
        <th>Dex</th>
        <th>Spike</th>
        <th>×倍率</th>
        <th>基準期間</th>
        <th>LP(推定)%</th>
        <th>h24%</th>
        <th>流動性USD</th>
        <th>Links</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<script>
const $ = (s)=>document.querySelector(s);
const logEl = $("#log");
function log(msg){ const t = typeof msg==="string" ? msg : JSON.stringify(msg); logEl.textContent += (t + "\n"); logEl.scrollTop = logEl.scrollHeight; }

// ---- Dates init (default: last 14d) ----
(function setDates(){
  const now = new Date();
  const end = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  const start = new Date(end.getTime() - 14*86400*1000);
  $("#startDate").value = start.toISOString().slice(0,10);
  $("#endDate").value   = end.toISOString().slice(0,10);
})();

// ---- Persist worker URL ----
const workerInput = $("#workerUrl");
workerInput.value = localStorage.getItem("workerUrl") || workerInput.value;
workerInput.addEventListener("change", ()=>localStorage.setItem("workerUrl", workerInput.value.trim()));

// ---- Utils ----
function normUnix(x){
  const n = Number(x);
  if(!Number.isFinite(n)) return null;
  return n > 1e12 ? Math.floor(n/1000) : Math.floor(n); // ms→s を吸収
}
function normalizeWorker(base){
  if(!base) return "";
  let u = base.trim();
  if(!u.includes("?")) { if(!u.endsWith("/")) u+="/"; u += "?url="; }
  else if(!u.includes("url=")) { if(!u.endsWith("&") && !u.endsWith("?")) u+="&"; u+="url="; }
  return u;
}
async function fetchJSON(rawUrl){
  const worker = normalizeWorker(($("#workerUrl").value||"").trim());
  const tries = [];
  if(worker) tries.push(worker + encodeURIComponent(rawUrl)); // Worker first
  tries.push(rawUrl); // direct (GitHub PagesはOKのことが多い)
  for(const u of tries){
    try{
      const res = await fetch(u, {method:"GET", mode:"cors"});
      if(!res.ok) throw new Error(`${res.status} ${res.statusText}`);
      const ct = res.headers.get("content-type")||"";
      if(!ct.includes("application/json")) { const tx = await res.text(); try { return JSON.parse(tx); } catch { throw new Error("Non-JSON"); } }
      return await res.json();
    }catch(e){ log(`fetch failed: ${u} ${e.message}`); }
  }
  throw new Error("All fetch attempts failed: " + rawUrl);
}

// ---- Data sources (GeckoTerminal / DexScreener / Ethplorer) ----
// GeckoTerminal: trending pools by network (eth)
async function gtTrending(limit=100){
  const url = `https://api.geckoterminal.com/api/v2/networks/eth/trending_pools?include=base_token%2Cquote_token%2Cdex&aggregate=1&limit=${limit}`;
  const j = await fetchJSON(url);
  if(!j || !j.data) return [];
  // index included tokens
  const incMap = new Map();
  for(const inc of (j.included||[])){
    if(inc.type==='token' && typeof inc.id==='string'){
      incMap.set(inc.id, {
        address: inc.id.split('_')[1]?.toLowerCase(),
        symbol: inc.attributes?.symbol || '',
        name: inc.attributes?.name || ''
      });
    }
  }
  const out = [];
  for(const d of j.data){
    const a = d.attributes||{}; const r = d.relationships||{};
    const baseId = r.base_token?.data?.id;
    const quoteId= r.quote_token?.data?.id;
    const base = incMap.get(baseId)||{};
    const quote= incMap.get(quoteId)||{};
    out.push({
      tokenName: base.name || a.name || '',
      tokenSymbol: base.symbol || '',
      tokenAddress: base.address || '',
      poolAddress: (a.address||'').toLowerCase(),
      dex: r.dex?.data?.id || '',
      h24: (a.price_change_percentage||{}).h24 ?? null,
      reserve_usd: a.reserve_in_usd ?? null,
      quoteSymbol: quote.symbol || 'WETH',
      source: 'gt_trending'
    });
  }
  return out;
}

// DexScreener: latest token profiles (optional seed; schemaは可変のためbest-effort)
async function dsLatest(limit=200){
  try{
    const url = 'https://api.dexscreener.com/token-profiles/latest/v1';
    const j = await fetchJSON(url);
    if(!Array.isArray(j)) return [];
    const out = [];
    for(const p of j){
      const addr = (p?.address || p?.tokenAddress || '').toLowerCase();
      const chain = (p?.chain || p?.chainId || p?.chainIdHex || '').toString().toLowerCase();
      if(!addr) continue;
      if(p?.chains && Array.isArray(p.chains) && !p.chains.includes('ethereum')) continue;
      if(chain && !chain.includes('eth')) continue; // heuristic
      out.push({
        tokenName: p.name || p.symbol || '',
        tokenSymbol: p.symbol || '',
        tokenAddress: addr,
        poolAddress: '', // 後でGT検索で補完（本実装では未実施）
        dex: '',
        h24: null,
        reserve_usd: null,
        quoteSymbol: 'WETH',
        source: 'ds_latest'
      });
      if(out.length>=limit) break;
    }
    return out;
  }catch(e){ log("DexScreener latest error: " + e.message); return []; }
}

// GeckoTerminal: pool OHLCV（日足）
async function gtOHLCV_day(poolAddress, days=60){
  const url = `https://api.geckoterminal.com/api/v2/networks/eth/pools/${poolAddress}/ohlcv/day?aggregate=1&limit=${days}`;
  const j = await fetchJSON(url);
  const arr = j?.data?.attributes?.ohlcv_list || [];
  // each row: [ts, o, h, l, c, v]
  return arr.map(([ts,o,h,l,c,v]) => ({ ts: normUnix(ts), c: Number(c) }))
            .filter(r => Number.isFinite(r.ts) && Number.isFinite(r.c));
}

// Ethplorer: top holders（LPロックの簡易推定）
async function ethplorerTopHolders(tokenAddress){
  const url = `https://api.ethplorer.io/getTopTokenHolders/${tokenAddress}?apiKey=freekey&limit=100`;
  return await fetchJSON(url);
}
function estimateLpLockPct(topHoldersJson){
  const H = topHoldersJson?.holders || [];
  const tags = ['LOCK','LOCKER','UNICRYPT','PINK','TEAM','BURN','DEAD','0X0000000000000000000000000000000000000000','LP','PAIR','UNISWAP'];
  let pct = 0;
  for(const h of H){
    const a = (h.address||'').toUpperCase();
    if(tags.some(t => a.includes(t))) pct += Number(h.share||0);
  }
  return Math.min(100, pct);
}

// スパイク検出（「ある日tの終値 / 直前D日間の最安終値」 >= 倍率）
function detectSpike(rows, D, mult, startTs, endTs){
  if(!rows.length) return null;
  // 期間で絞り込み
  const f = rows.filter(r => (!startTs || r.ts>=startTs) && (!endTs || r.ts<=endTs));
  if(f.length<2) return null;
  // スライディング最小（直前D日分の最小終値）
  const window = [];
  let best = null;
  for(let i=0;i<f.length;i++){
    const cur = f[i];
    // 直前D日範囲
    const tMin = cur.ts - D*86400;
    // window から範囲外を除去
    while(window.length && window[0].ts < tMin) window.shift();
    // 今時点の直前最安
    const minPrev = window.length ? Math.min(...window.map(x=>x.c)) : null;
    if(minPrev && minPrev>0){
      const ratio = cur.c / minPrev;
      if(ratio >= mult){
        if(!best || ratio > best.ratio){
          best = { ratio, at: cur.ts, from: window.reduce((a,b)=> a.c<b.c? a:b).ts };
        }
      }
    }
    // push current
    window.push(cur);
  }
  return best; // {ratio, at, from}
}

// ---- Main flow ----
async function run(){
  $("#csvBtn").disabled = true;
  $("#tbl").style.display = "none";
  logEl.textContent = "";

  const startTs = new Date($("#startDate").value+"T00:00:00Z").getTime()/1000|0;
  const endTs   = new Date($("#endDate").value+"T23:59:59Z").getTime()/1000|0;
  const D       = parseInt($("#pumpDays").value,10) || 14;
  const mult    = parseFloat($("#pumpMult").value) || 3;
  const lpMin   = Math.max(0, Math.min(100, parseFloat($("#lpThreshold").value)||80));
  const maxRows = parseInt($("#maxRows").value,10) || 150;

  log(`Params: days=${D}, mult=${mult}, LP≥${lpMin}%, start=${startTs}, end=${endTs}`);

  // 1) シード: GeckoTerminal trending
  const seedGT = await gtTrending(120);
  log(`GeckoTerminal trending seeds: ${seedGT.length}`);

  // 2) 追加シード: DexScreener latest（取得できたら結合）
  const seedDS = await dsLatest(120);
  log(`DexScreener latest seeds: ${seedDS.length}`);

  // 結合 & 去重（tokenAddress基準）
  const map = new Map();
  for(const s of [...seedGT, ...seedDS]){
    if(!s.tokenAddress) continue;
    if(!map.has(s.tokenAddress)) map.set(s.tokenAddress, s);
  }
  const seeds = [...map.values()];
  log(`Total unique seeds: ${seeds.length}`);

  const out = [];
  for(const s of seeds){
    try{
      // プールが無い場合はスキップ（DSからの種はプール不明のことがある）
      if(!s.poolAddress){ /* TODO: 必要なら search/pools で補完 */ continue; }

      // 3) OHLCV（日足）でスパイク判定
      const rows = await gtOHLCV_day(s.poolAddress, Math.max(60, D+16));
      const spike = detectSpike(rows, D, mult, startTs, endTs);
      if(!spike) continue;

      // 4) LPロック（簡易推定）
      let lpPct = 0;
      try { const th = await ethplorerTopHolders(s.tokenAddress); lpPct = estimateLpLockPct(th); }
      catch(e){ log(`Ethplorer error ${s.tokenAddress}: ${e.message}`); }

      if(lpPct < lpMin) continue;

      out.push({
        token: s.tokenName || s.tokenSymbol || "(unknown)",
        address: s.tokenAddress,
        pool: s.poolAddress,
        dex: s.dex || "",
        spike: "YES",
        ratio: spike.ratio,
        window: `${new Date(spike.from*1000).toISOString().slice(0,10)} → ${new Date(spike.at*1000).toISOString().slice(0,10)}`,
        lp: lpPct,
        h24: s.h24,
        liq: s.reserve_usd,
        links: [
          `https://www.geckoterminal.com/eth/pools/${s.pool}`,
          `https://etherscan.io/token/${s.address}`,
          `https://dexscreener.com/ethereum/${s.pool}`
        ]
      });
      if(out.length >= maxRows) break;
    }catch(e){
      log(`analyze error ${s.tokenAddress}: ${e.message}`);
    }
  }

  // 表示
  out.sort((a,b)=> (b.ratio||0)-(a.ratio||0));
  const tb = $("#tbl tbody"); tb.innerHTML = "";
  out.forEach((r,i)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${i+1}</td>
      <td>${r.token}</td>
      <td class="muted"><code>${r.address}</code></td>
      <td class="muted"><code>${r.pool}</code></td>
      <td>${r.dex||""}</td>
      <td>${r.spike}</td>
      <td>${(r.ratio||0).toFixed(2)}x</td>
      <td>${r.window}</td>
      <td>${(r.lp||0).toFixed(1)}</td>
      <td>${r.h24??""}</td>
      <td>${r.liq!=null ? Math.round(r.liq).toLocaleString() : ""}</td>
      <td>${r.links.map(u=>`<a href="${u}" target="_blank" rel="noopener">link</a>`).join(" / ")}</td>
    `;
    tb.appendChild(tr);
  });
  $("#tbl").style.display = out.length ? "" : "none";
  $("#csvBtn").disabled = out.length===0;
  log(`完了: ${out.length} hits (showing ${Math.min(out.length, maxRows)})`);
}

// CSV
$("#csvBtn").addEventListener("click", () => {
  const rows = [...document.querySelectorAll("#tbl tbody tr")].map(tr => 
    [...tr.children].map(td => `"${String(td.innerText).replaceAll('"','""')}"`).join(","));
  const header = [...document.querySelectorAll("#tbl thead th")].map(th => `"${th.innerText}"`).join(",");
  const csv = [header, ...rows].join("\n");
  const blob = new Blob([csv], {type:"text/csv"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "meme-coin-eth-latest.csv"; a.click();
  URL.revokeObjectURL(url);
});

$("#runBtn").addEventListener("click", run);
</script>
</body>
</html>
